@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@* @{
    "orderId": 64,
      "orderId": 6,
      "ordered_Date": "2024-10-25T00:00:00",
      "statusId": 1,
      "discount": 10,
      "shipping": 100,
      "totalAmount": 3693.7,
      "address": "Madurai"
} *@
@model IEnumerable<BookstoreMVC.Models.Order>
 @if (TempData["role"].ToString() == "3")
{
    <h3>Orders list</h3>
}
@if (TempData["role"].ToString() == "1")
{
    <h3>My Orders</h3>
}

<table class="table">
    <thead>
        <tr>
            @if (TempData["role"].ToString() == "3")
            {
                <th>Customer Name</th>
                <th>Date</th>
                <th>Address</th>
                <th>Amount</th>
                <th>Action</th>
            }
            @if (TempData["role"].ToString() == "1")
            {
                <th>OrderId</th>
                <th>Date</th>
                <th>Discount</th>
                <th>Shipping</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Action</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            @if (TempData["role"].ToString() == "3")
            {
                <tr>
                    <td>@item.Username</td>
                    <td>@item.Ordered_Date</td>
                    <td>@item.Address</td>
                    
                    <td>@item.TotalAmount</td>
                    @* @if (item.StatusId == 1 || item.StatusId == 2 || item.StatusId == 3)
                    {
                        <td>
                            <a class=" btn-sm btn-danger" id="delOrder" onclick="delOrder(@item.OrderId);"> Cancel</a>
                            <a href="/Order/GetBooksFromOrder/@item.OrderId" class="btn-sm btn-primary ms-2">View Details</a>
                        </td>
                    }
                    @if (item.StatusId == 4)
                    {
                        <td>
                            Cancelled
                            <a href="/Order/GetBooksFromOrder/@item.OrderId" class="btn-sm btn-primary ms-2">View Details</a>
                        </td>
                    } *@
                   <td>
                        <select asp-items=@ViewBag.statuses onchange="update(@item.StatusId)"></select>
                        @if (@item.StatusId > 0)
                        {
                            <a class=" btn-sm btn-primary" id="updateStatus" onclick="updateStatus(@item.OrderId,@item.StatusId);"> Save</a>
                        }
                    </td> 
                </tr>
            }

            @if (TempData["role"].ToString() == "1")
            {
                <tr>
                    <td>@item.OrderId</td>
                    <td>@item.Ordered_Date</td>
                    <td>@item.Discount</td>
                    <td>@item.Shipping</td>
                    <td>@item.TotalAmount</td>
                    <td>@item.status</td>
                    @if (item.StatusId == 1 )
                    {
                        <td>
                            <a class=" btn-sm btn-danger" id="delOrder" onclick="delOrder(@item.OrderId);"> Cancel</a>
                            <a href="/Order/GetBooksFromOrder/@item.OrderId" class="  btn-sm btn-primary ms-2">View Details</a>
                        </td>
                    }
                    @if (item.StatusId == 4)
                    {
                        <td>
                            Cancelled
                            <a href="/Order/GetBooksFromOrder/@item.OrderId" class="  btn-sm btn-primary ms-2">View Details</a>
                        </td>
                    }
                </tr>
                
            }
             
        }

    </tbody>
   
</table>

<script type="text/javascript">

    function delOrder(id) {
        let delItem = id.toString();
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, Cancel it!",
            cancelButtonText: "No"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    type: "POST",
                    datatype: "json",
                    contentType: "application/json;charset=UTF-8", 
                    url: "/Order/DeleteOrder?orderId="+ delItem,
                    success: function () {
                        setTimeout(myTimeout, 1000);
                        
                    },
                    error: function () {
                        Swal.fire({
                            text: "Error",
                            icon: "danger",
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                })

            }
        })
    }
        function myTimeout() {
            location.reload();
        }

    function updateStatus(id) {
        let delItem = id.toString();
        $.ajax({
            type: "POST",
            datatype: "json",
            contentType: "application/json;charset=UTF-8",
            url: "/Order/UpdateOrder?orderId=" + delItem,
            success: function () {
                setTimeout(myTimeout, 1000);

            },
            error: function () {
                alert("error")
            }
        })
    }

</script>